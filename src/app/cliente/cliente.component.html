<div class="client-panel-wrapper">

  <header class="client-panel-header">
    <h1 class="main-title">{{ infoRestaurante.nombre || 'Panel del Cliente' }}</h1>
    <button class="logout-btn" (click)="logout()">Cerrar sesión</button>
  </header>

  <div class="client-panel-grid">
    <main class="main-content">

      <!-- Card: Realizar Nueva Reserva -->
      <div class="card new-reservation-card">
        <h2 class="card-header">Realizar Nueva Reserva</h2>
        <div class="card-body">
          <form class="reservation-form" #reservaForm="ngForm">
            <div class="form-row">
              <div class="form-group">
                <label for="res-date">Fecha</label>
                <input type="date" id="res-date" class="form-control" name="fecha" [(ngModel)]="nuevaReserva.fecha" (change)="onFechaChange()" required />
              </div>
              <div class="form-group">
                <label for="res-time">Horario</label>
                <select id="res-time" class="form-control" name="horario" [(ngModel)]="nuevaReserva.horario" required>
                  <option value="" disabled [selected]="!nuevaReserva.horario">{{ nuevaReserva.fecha ? 'Selecciona un horario' : 'Selecciona una fecha' }}</option>
                  <option *ngFor="let horario of horariosDisponibles" [value]="horario">{{ horario }}</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="res-people">Número de Personas</label>
                <input type="number" id="res-people" class="form-control" name="cantidadPersonas" [(ngModel)]="nuevaReserva.cantidadPersonas" min="1" required />
              </div>
              <div class="form-group">
                <label for="res-zone">Zona preferida</label>
                <select id="res-zone" class="form-control" name="zonaPreferida" [(ngModel)]="nuevaReserva.zonaPreferida" required>
                  <option value="" disabled selected>Selecciona una zona</option>
                  <option *ngFor="let zona of zonasRestaurante" [value]="zona">{{ zona }}</option>
                </select>
              </div>
            </div>
            <button type="button" class="btn-submit" (click)="verMesasDisponibles()" [disabled]="!reservaForm.valid">Ver mesas disponibles</button>
          </form>
        </div>
      </div>

      <!-- Card: Mesas Disponibles -->
      <div class="card available-tables-card" *ngIf="mesasDisponibles.length > 0 && !reservaAEditar">
        <h2 class="card-header">Mesas Disponibles</h2>
        <div class="card-body">
          <ul class="available-table-list">
            <li *ngFor="let mesa of mesasDisponibles" (click)="mesaSeleccionada = mesa" [ngClass]="{ 'selected': mesaSeleccionada?.id === mesa.id }">
              <strong>{{ mesa.label }}</strong> — Capacidad: {{ mesa.capacity }} personas
              <span class="zone-info">({{ mesa.zone }})</span>
            </li>
          </ul>
          <div class="confirm-reservation" *ngIf="mesaSeleccionada">
            <h3>Mesa seleccionada: {{ mesaSeleccionada.label }}</h3>
            <button class="btn-confirm" (click)="confirmarReserva()">Confirmar Reserva</button>
          </div>
        </div>
      </div>

      <!-- Card: Mis Reservas Activas -->
      <div class="card active-reservations-card">
        <h2 class="card-header">Mis Reservas</h2>
        <div class="card-body">
          <ng-container *ngIf="misReservas.length > 0; else noReservas">
            <div *ngFor="let reserva of misReservas" class="reservation-item" [ngClass]="reserva.statusClass">
              <div class="res-info">
                <strong>Reserva #{{ reserva.id }}</strong>
                <span class="status-badge" [ngClass]="reserva.statusClass">{{ reserva.reservation_status | titlecase }}</span>
                <span>{{ reserva.fecha }} | {{ reserva.horario }}</span>
                <span>Mesa {{ reserva.mesa }} ({{ reserva.zona }}) - {{ reserva.personas }} personas</span>
              </div>
              <div class="res-actions">
                <ng-container *ngIf="reserva.reservation_status === 'confirmed' || reserva.reservation_status === 'pending'">
                  <button class="btn-modify" (click)="openModal(reserva.id)">Modificar</button>
                  <button class="btn-cancel" (click)="cancelarReserva(reserva.id)">Cancelar</button>
                </ng-container>
              </div>
            </div>
          </ng-container>
          <ng-template #noReservas>
            <p class="no-data-message">No tienes ninguna reserva activa.</p>
          </ng-template>
        </div>
      </div>
    </main>

    <aside class="sidebar">
      <div class="card table-status-card">
        <h2 class="card-header">Estado de Mesas</h2>
        <div class="card-body">
          <ul class="status-legend">
            <li><span class="status-dot available"></span> Disponible</li>
            <li><span class="status-dot reserved"></span> Reservada</li>
            <li><span class="status-dot maintenance"></span> Mantenimiento</li>
            <li><span class="status-dot occupied"></span> Ocupada</li>
          </ul>
        </div>
      </div>

      <div class="card restaurant-info-card">
        <h2 class="card-header">Información del Restaurante</h2>
        <div class="card-body">
          <p><strong>Horario:</strong> {{ infoRestaurante.horario_apertura }} - {{ infoRestaurante.horario_cierre }}</p>
          <p><strong>Teléfono:</strong> {{ infoRestaurante.telefono }}</p>
          <p><strong>Dirección:</strong> {{ infoRestaurante.direccion }}</p>
        </div>
      </div>
    </aside>
  </div>

  <footer class="client-panel-footer">
    <p>© 2025 {{ infoRestaurante.nombre || 'Reserva de Restaurante' }}. Todos los derechos reservados.</p>
  </footer>

</div>

<!-- MODAL DE EDICIÓN DE RESERVA -->
<div class="modal-overlay" *ngIf="reservaAEditar">
  <div class="modal-content">
    <div class="modal-header-wrapper">
      <h3 class="modal-title">Modificar Reserva #{{ reservaAEditar.id }}</h3>
      <button class="modal-close-btn" (click)="closeModal()">&times;</button>
    </div>
    <form class="modal-reservation-form" (ngSubmit)="confirmarReserva()">
      <div class="form-row">
        <div class="form-group">
          <label for="modal-date">Fecha</label>
          <input type="date" id="modal-date" class="form-control" name="modalFecha" [(ngModel)]="nuevaReserva.fecha" (change)="onFechaChange()" required />
        </div>
        <div class="form-group">
          <label for="modal-time">Horario</label>
          <select id="modal-time" class="form-control" name="modalHorario" [(ngModel)]="nuevaReserva.horario" required>
            <option *ngFor="let h of horariosDisponibles" [value]="h">{{ h }}</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="modal-people">Personas</label>
          <input type="number" id="modal-people" class="form-control" name="modalCantidadPersonas" [(ngModel)]="nuevaReserva.cantidadPersonas" min="1" required />
        </div>
        <div class="form-group">
          <label for="modal-zone">Zona</label>
          <select id="modal-zone" class="form-control" name="modalZonaPreferida" [(ngModel)]="nuevaReserva.zonaPreferida" required>
            <option *ngFor="let z of zonasRestaurante" [value]="z">{{ z }}</option>
          </select>
        </div>
      </div>
      <button type="button" class="btn-submit-modal" (click)="verMesasDisponibles()">Buscar Mesas</button>
      <div class="available-tables-modal" *ngIf="mesasDisponibles.length > 0">
        <h4>Selecciona una nueva mesa:</h4>
        <ul class="available-table-list">
          <li *ngFor="let mesa of mesasDisponibles" (click)="mesaSeleccionada = mesa" [ngClass]="{ 'selected': mesaSeleccionada?.id === mesa.id }">
            <strong>{{ mesa.label }}</strong> (Cap: {{ mesa.capacity }}) - {{ mesa.zone }}
          </li>
        </ul>
      </div>
      <div *ngIf="mesasDisponibles.length === 0" class="no-tables-message">
        <p>No hay mesas disponibles con los nuevos criterios.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
        <button type="submit" class="btn-confirm" [disabled]="!mesaSeleccionada">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>